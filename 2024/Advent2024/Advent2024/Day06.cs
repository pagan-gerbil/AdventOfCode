using AdventUtils;
using AdventUtils.Models;

namespace Advent2024;

internal class Day06 : DayBase
{
    protected override string _sample1 => "....#.....\r\n.........#\r\n..........\r\n..#.......\r\n.......#..\r\n..........\r\n.#..^.....\r\n........#.\r\n#.........\r\n......#...";

    protected override string _part1 => ".....#..#................#...###..............................#..#.......................................#........................\r\n..................#...........#.............#.#.#.#......................#.......##.........................................#.##.#\r\n....#.......................................................#.......#.........................#...................................\r\n.#.............#...........#..........................#.....................................................................#.....\r\n....#..#................#..........................#..#..#...#..........#....................................#.#..................\r\n...........................#....#.##......................................................................##...................#..\r\n...........................#.....................................#....##.#..#..#.....#................#...........................\r\n.....#..............#........#........................................###...........#..................................#..........\r\n........#..............#............................................................#..............................#..............\r\n......#..............................#..........................#................................................#................\r\n................#..#......................#.......................................................................................\r\n..#.............................##.....#.......................................................#..................................\r\n#.......................................#...#.............................#...........#.#.........#.............#.................\r\n..............................#................................#...#................................................#.............\r\n..............#...............#.................#........................#...#.....#................#.............................\r\n...................................#...#...........#...............#.........#............#...............##...........#.#........\r\n.........................#..................................................................#.........#...........................\r\n.##.............#................................#.......#.........#..............................................#...............\r\n....#.................#.....#.......................................................#......................#......................\r\n#..................................#................#......#.........................#............................................\r\n.....#..................#................#........................................................................................\r\n......#......#.......#......#.#....................#..................................#...................#...#...............#.#.\r\n.................................................#......#......#.........#..................#.....................................\r\n...........#.....#..................................#...#........#......#...#..................#.##....#.................#.......#\r\n........#..#....................................#...................................................................#.......#.....\r\n...........#..............#.............................................#..............#.#........#..##.................#.......#.\r\n......................................#............................................#...#..........................................\r\n.......#.............#............................#.........#................#.......................................#............\r\n..........................................................................#.............#...............................#.........\r\n......##...............#..........................................................................................#...............\r\n.........#..#................................................#..................................#.......#.....................#...\r\n...#..............................#.#.............#........................#..............#..............................#........\r\n.......................................................................................................#.............#............\r\n.....#.......................#..#..........#.....................................................................................#\r\n..........##..........................#...............................#.......................#...............#.............#..#..\r\n..#....#....................#.............#......#.............................................................#..................\r\n.#....#..........................................................................................#.#......#.....................#.\r\n..........................#.......#......................................................#........................................\r\n.#......#.#......................................................................#........#.........#.........#.#.................\r\n.....................................#........#..........#.............................#..#............#....................#.....\r\n............#.........#.........................................................................................#........##.......\r\n....................#.................#.........................#......................#......................................#...\r\n............#....................................................#..#.........#..........#...................................#....\r\n#.....#...................#.........#.#..................................................................................#........\r\n.............................##.......#........................................#..........#..............#..#.....................\r\n.............#....................................^.##....................................................#.....................#.\r\n........................#.#..#......................#............#...#..........................#.......................#.........\r\n......................#.......................................................................#.#..#......................#.......\r\n..................................................#.......##...................................#..................................\r\n.............................#..........................................#..............#.#.............................#..........\r\n....#.............#..................#.....#..........................#....#..........#.........#........................#.......#\r\n...............#...........................#...............#....................................................................#.\r\n..........................#.............#..........................................................#..............................\r\n...............#...................................#.......................#.............................#...............#........\r\n....#......................##......#.#................................................#................#.............#............\r\n.......#...................#..........................................#.....................................#.....................\r\n.#.....................#..........................................................................................................\r\n........#.#...........#....#...................................#..#.#....#..................#.#...............#......#........#...\r\n#....#............#...#.........#...........#......................#.....................#........................................\r\n........................#.............#.................................................................#.....#...................\r\n...............#....................#................##...#...........#.#..............#..........................................\r\n........................#...........##.......#.....#...........................#..#...................................#...........\r\n.............#........................................................................#.....#.#.#.................##..............\r\n......#......................#.........#..............#...............#................#..................#........#..............\r\n..........#..........................................................................................................#............\r\n..................#...........#................#..#.#..............#.#........#...............................#....#..........##..\r\n...........#..............#...................................................#...................................................\r\n..................................................................#............#............................#.................#...\r\n....#...........#...................#..........................................#..........#...........................#...........\r\n........................................#....................#....#..#........................#.....#.............................\r\n................#........................................................................................................#........\r\n...................#......#.....#..............#..................................#...#.............#........................#....\r\n...................#............................................................#.............#...................................\r\n.......#........................#..........#.............#....#....#.............#.............................#...#..............\r\n...#...............##.............................................................#.................#........................#....\r\n.............................#.................#..................#.#....................#.....................................###\r\n...............#....#.....................................................#..............................................#.......#\r\n....................................#..................................#.......................#..................................\r\n#..#............#................................#....#...............#.........#...........................#.....................\r\n...........................................................................................................#.............#....#..#\r\n...................................#....#.........#..................#......#....................#..........#.....................\r\n...........#.............................................................##.#......#.....#......................#...#.............\r\n..#...................................................................................#.................#.........#...............\r\n.......#..#..#.................................#.....................#..............................................#....#........\r\n..........................#....................................................................................................#..\r\n..#.............#......#..................................#..#.......................#..........#...#...##......#.................\r\n....#...................#....#.........................................................#..................................#.......\r\n.................................#...............#.....................#..#.......................................................\r\n...........#......................................................................................................#...........#...\r\n.............#.................................................................#............#..................#........#.........\r\n.......................#.......#..........................................................#...............................#.....#.\r\n...........................................................................#....#....#............................#...............\r\n....................#............#................................................................................................\r\n.....#.........................................#...................#.....#...#.......#..............#............................#\r\n...#.......................................#.........#............#...................#......................#....#............##.\r\n...##.#...........................................#...#................#..........................................................\r\n.......#..##............#..#............#......................................#...............#...........#.........#......#..#..\r\n...............................................................................#.........##........##.............#...............\r\n......#...............................#.........#............#..............................#.........................#....#......\r\n#...........................#....#..#....................................................#..................#.....................\r\n......#.##.......#...........................#...#........#.................................................................#.....\r\n..........#.................................................#..........................................#....#.#.........#.#.#.....\r\n...#...#.....#......#.......#..#.#.........#...............................................................#..........##.........#\r\n..#...#...#..........................................#............................#..........#..........#.........................\r\n#....#............#......#.............#.#.......##...............#................#.............................#................\r\n...............................#...............................................................#..............#.........#.........\r\n....#..............#..#............................................................#.......#................#...................#.\r\n....#...........................#.............................#.............#....#.........#....#...................#.......#.#...\r\n.......#.......................................#....#........#..............#........#....................#.......................\r\n........#...........................#................................#............................................................\r\n...........#....#........#......................................#...........#.................................#..........#........\r\n........#..........................................................................................#...........................#..\r\n#........................................#.................................................................##...#.....#...........\r\n............#..............#...........#............#................#..#.......................#.#.....#.............##..........\r\n..........#..................#..................................................................................................#.\r\n.....................................#..............##..................................#.............#........#..................\r\n..............................#..................#...............#......#..##....................#................................\r\n..#............#....................................#.......................................................#...#.................\r\n..................###..........................#.......#.................................#........................................\r\n.....#.#..........................................................#...........##...#.....#.................................#......\r\n.............................................#.............................#......................#.............#.......#.....#...\r\n...#......................#............#..................................#........................#....................#.......#.\r\n....##..........#..........#...#.............#............#....#......#....................#...........#..#..........#............\r\n..#......................#............#..#..#.......................#.........#......#...............#............#..#............\r\n..#.............#.#.............................#......#......#.........................#......#.#...............#...............#\r\n...#...........#...............#.....................................#.................#....#....#...................#.#...#......\r\n.......#........#....................#.............................................#..............................................\r\n........#............................#....#....#........#...................#.#...............#...#.....................#.........\r\n.##........#.................#...........#...............................##.#.....................................................\r\n.###...........................#........#..#................................................#...........................#.........";

    protected override string Part1Internal(string input)
    {
        var visitedLocations = GetVisitedLocations(input);

        return (visitedLocations.Count + 1).ToString();
    }

    private Dictionary<(int Row, int Column), Direction> GetVisitedLocations(string input)
    {
        var lines = input.Split(Environment.NewLine);

        var startCoords = (Row: 0, Column: 0);

        var row = 0;
        foreach (var l in lines)
        {
            if (l.Contains('^'))
            {
                startCoords = (row, l.IndexOf('^'));
                break;
            }

            row++;
        }

        var direction = Direction.Up;

        var visitedLocations = new Dictionary<(int Row, int Column), Direction>();

        var finished = false;
        while (!finished)
        {
            visitedLocations.TryAdd(startCoords, direction);
            var path = GetPath(direction, startCoords, lines);
            var block = path.IndexOf('#');
            var newCoords = (0, 0);

            if (block < 0)
            {
                block = path.Count - 1;
                finished = true;
            }

            switch (direction)
            {
                case Direction.Up:
                    newCoords = (startCoords.Row - block, startCoords.Column);
                    if (visitedLocations.ContainsKey(newCoords) && visitedLocations[newCoords] == Direction.Up)
                    {
                        return null;
                    }
                    for (var i = startCoords.Row - block; i <= startCoords.Row; i++)
                    {
                        visitedLocations.TryAdd((i, startCoords.Column), direction);
                    }
                    break;
                case Direction.Down:
                    newCoords = (startCoords.Row + block, startCoords.Column);
                    if (visitedLocations.ContainsKey(newCoords) && visitedLocations[newCoords] == Direction.Down)
                    {
                        return null;
                    }
                    for (var i = startCoords.Row; i <= startCoords.Row + block; i++)
                    {
                        visitedLocations.TryAdd((i, startCoords.Column), direction);
                    }
                    break;
                case Direction.Left:
                    newCoords = (startCoords.Row, startCoords.Column - block);
                    if (visitedLocations.ContainsKey(newCoords) && visitedLocations[newCoords] == Direction.Left)
                    {
                        return null;
                    }
                    for (var i = startCoords.Column - block; i <= startCoords.Column; i++)
                    {
                        visitedLocations.TryAdd((startCoords.Row, i), direction);
                    }
                    break;
                case Direction.Right:
                    newCoords = (startCoords.Row, startCoords.Column + block);
                    if (visitedLocations.ContainsKey(newCoords) && visitedLocations[newCoords] == Direction.Right)
                    {
                        return null;
                    }
                    for (var i = startCoords.Column; i <= startCoords.Column + block; i++)
                    {
                        visitedLocations.TryAdd((startCoords.Row, i), direction);
                    }
                    break;
            }

            direction++;
            if (direction == Direction.Turn) direction = Direction.Up;

            startCoords = newCoords;
        }

        return visitedLocations;
    }

    protected override string Part2Internal(string input)
    {
        var counter = 0;

        var candidates = GetVisitedLocations(input);

        foreach (var candidate in candidates) {
            var lines = input.Split(Environment.NewLine);
            var newLine = new string(
                [
                ..lines[candidate.Key.Row].Substring(0, candidate.Key.Column), 
                '#', 
                ..lines[candidate.Key.Row].Substring(candidate.Key.Column+1)]);

            var trial = input.Replace(lines[candidate.Key.Row], newLine);

            var path = GetVisitedLocations(trial);
            if (path == null)
            {
                counter++;
            }
        }

        return counter.ToString();
        // 711 is too low
    }

    private List<char> GetPath(Direction direction, (int Row, int Column) startCoords, string[] lines)
    {
        List<char> path = null;
        switch (direction)
        {
            case Direction.Up:
                path = lines.Where((a, i) => i < startCoords.Row).Select(a => a[startCoords.Column]).Reverse().ToList();
                break;
            case Direction.Down:
                path = lines.Where((a, i) => i > startCoords.Row).Select(a => a[startCoords.Column]).ToList();
                break;
            case Direction.Left:
                path = lines[startCoords.Row].Substring(0, startCoords.Column).Reverse().ToList();
                break;
            case Direction.Right:
                path = lines[startCoords.Row].Substring(startCoords.Column + 1).ToList();
                break;
        }

        return path ?? new List<char>();
    }
}
